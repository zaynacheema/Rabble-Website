{% extends "rabble/base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
  <div class="container" style="padding: 1.5rem">
    <a href="{% url 'subrabble-detail' subrabble.id %}">‚Üê Back to !{{ subrabble.id }} ‚Äî {{ subrabble.name }}</a>

    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="margin: 0;">{{ post.title }}</h2>
      {% if request.user == post.author %}
        <a href="{% url 'post-edit' subrabble.id post.id %}">Edit Post</a>
      {% endif %}
    </div>

    <p><em>By {{ post.author.username }}</em></p>

    <p>{{ post.body }}</p>
    <p>
      <button id="like-button" style="border: none; background: none; cursor: pointer; font-size: 1.5rem;">
        <span id="like-icon" style="font-size: 1.2rem;">üëç</span>
        <span id="like-count" style="font-size: 1rem;">{{ post.likes.count }}</span>
      </button>
      üí¨ {{ post.num_comments }}
    </p>
    <h3>Comments</h3>

    {% if post.comment_set.count %}
      {% for comment in post.comment_set.all %}
        <div style="border-top: 1px solid #ccc; margin-top: 1rem; padding-top: 1rem;">
          <p>{{ comment.body }}</p>
          <p><em>By {{ comment.author.username }}</em></p>
        </div>
      {% endfor %}
    {% else %}
      <p>No comments yet. Be the first to comment!</p>
    {% endif %}
  </div>
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
  <script>
    const likeIcon = document.getElementById('like-icon');
    const likeButton = document.getElementById('like-button');
    const likeCountSpan = document.getElementById('like-count');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const postId = '{{ post.id }}';
    const subrabbleId = '{{ subrabble.id }}';
    const username = '{{ user.username }}';

    likeButton.addEventListener('click', () => {
      fetch(`/api/subrabbles/!${subrabbleId}/posts/${postId}/likes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ user: username })
      })
      .then(response => response.json())
      .then(data => {
        likeCountSpan.textContent = data.like_count;
        if (data.liked) {
          likeIcon.style.backgroundColor = 'blue';
        } else {
          likeIcon.style.backgroundColor = 'black';
        }
      });
    });
  </script>
{% endblock %}
